// ==UserScript==
// @name         bliveproxy
// @namespace    http://tampermonkey.net/
// @version      0.3
// @description  B站直播websocket hook框架
// @author       https://github.com/xfgryujk
// @include      /https?:\/\/live\.bilibili\.com\/?\??.*/
// @include      /https?:\/\/live\.bilibili\.com\/\d+\??.*/
// @include      /https?:\/\/live\.bilibili\.com\/(blanc\/)?\d+\??.*/
// @run-at       document-start
// @require      https://cdn.jsdelivr.net/gh/google/brotli@5692e422da6af1e991f9182345d58df87866bc5e/js/decode.js
// @require      https://cdn.jsdelivr.net/npm/pako@2.0.3/dist/pako_inflate.min.js
// @grant        unsafeWindow
// ==/UserScript==
!function(){const e="undefined"==typeof unsafeWindow?window:unsafeWindow;let n=new TextEncoder,t=new TextDecoder;let r={addCommandHandler(e,n){let t=this._commandHandlers[e];t||(t=this._commandHandlers[e]=[]),t.push(n)},removeCommandHandler(e,n){let t=this._commandHandlers[e];t&&(this._commandHandlers[e]=t.filter((e=>e!==n)))},hook(){e.WebSocket=new Proxy(window.WebSocket,{construct(e,n){let t=new e(...n);return new Proxy(t,o)}})},_commandHandlers:{},_getCommandHandlers(e){return this._commandHandlers[e]||null}},o={get(e,n){let t=e[n];return"function"==typeof t&&(t=t.bind(e)),t},set(e,n,t){if("onmessage"===n){let e=t;t=function(n){!function(e,n){if(!(e.data instanceof ArrayBuffer))return void n(e);function t(t){n({...e,data:t})}i(new Uint8Array(e.data),t)}(n,e)}}return e[n]=t,t}};function a(e,n){let t=16+e.byteLength,r=new ArrayBuffer(t),o=3===n?1:0,a=new DataView(r);a.setUint32(0,t),a.setUint16(4,16),a.setUint16(6,o),a.setUint32(8,n),a.setUint32(12,1);let i=new Uint8Array(r,16,e.byteLength);for(let n=0;n<e.byteLength;n++)i[n]=e[n];return r}function i(e,n){let r=0;for(;r<e.byteLength;){let o=new DataView(e.buffer,r),f=o.getUint32(0),s=o.getUint16(6),l=o.getUint32(8),c=new Uint8Array(e.buffer,r+16,f-16);if(5===l)switch(s){case 0:c=t.decode(c),c=JSON.parse(c),d(c,n);break;case 2:c=pako.inflate(c),i(c,n);break;case 3:c=BrotliDecode(c),i(c,n);break;default:n(a(c,l));break}else{n(a(c,l))}r+=f}}function d(e,t){if(e instanceof Array){for(let n of e)this.handleCommand(n);return}let o=e.cmd||"",i=o.indexOf(":");-1!=i&&(o=o.substr(0,i));let d=r._getCommandHandlers(o);if(d)for(let n of d)n(e);t(function(e){return a(n.encode(JSON.stringify(e)),5)}(e))}window.bliveproxy||(window.bliveproxy=r)}();